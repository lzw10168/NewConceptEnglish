# https://www.ha85.com/lessons/76
# https://www.ha85.com/lessons/171


# <h1 class="timeline-header text-center px-md-3 text-md-left"><strong class="h5" data-toggle="tooltip" title="" data-original-title="难度：5星">Lesson 1 A Private Conversation</strong><span class="mx-2 text-gray">私人谈话</span><a href="javascript:playAudio('https://www.ha85.com/storage/lessons/76/notes/ksyrftxr1imqngboafzvjxeoiu3c6nowyctnsagm.mp3')" class="h6" data-toggle="tooltip" title="" data-original-title="播放课文音频 Play the text audio."> <i id="playaudio" class="fas fa-volume-up"></i> </a><span><a href="/tags/45" class="badge bg-orange" target="_blank">简单句</a> </span><div class="form-check mx-3 d-inline-block"><div class="d-none d-md-inline-block" data-toggle="tooltip" title="" data-original-title="朗读选中内容"><input class="form-check-input" id="reader" checked="" type="checkbox"><label class="form-check-label" for="reader"><i class="fas fa-book-reader"></i></label></div></div></h1>


# <div id="lesson"><p>Last week I went to the theatre.</p><div class="chinese">上星期我去看戏。</div><p>I had a very good seat.</p><div class="chinese">我的座位很好。</div><p>The play was very interesting. I did not enjoy it.</p><div class="chinese">戏很有意思，但我却无法欣赏。</div><p>A young man and a young woman were sitting behind me.</p><div class="chinese">一青年男子与一青年女子坐在我的身后。</div><p>They were talking loudly.</p><div class="chinese">大声地说着话。</div><p>I got very angry. I could not hear the actors.</p><div class="chinese">我非常生气，因为我听不见演员在说什么。</div><p>I turned round. I looked at the man and the woman angrily.</p><div class="chinese">我回过头去怒视着那一男一女。</div><p>They did not pay any attention.</p><div class="chinese">他们却毫不理会。</div><p>In the end, I could not bear it.</p><div class="chinese">最后, 我忍不住了。</div><p>I turned round again. "I can't hear a word!" I said angrily.</p><div class="chinese">又一次回过头去，生气地说 : "我一个字也听不见了！"</div><p>"It's none of your business, " the young man said rudely. "This is a private conversation!"</p><div class="chinese">"不关你的事，"那男的毫不客气地说，"这是私人间的谈话！"</div></div>


# <div class="alert alert-light align-items-center" id="question"><div class="headphones"><h5 class="h6 btn btn-app m-0 mr-3"><i class="fas fa-headphones-alt"></i><span id="progressBar"></span></h5></div><p class="mb-0 flex-grow-1">First listen and then answer the question: <span class="bg-info btn-sm d-inline-block">Why did the writer complain to the people behind him?</span> </p></div>

# <div id="words" class="words"><i class="bg-green fas fa-font" onclick="if (!window.__cfRLUnblockHandlers) return false; copy_url('https://www.ha85.com/lessons/76','words')"></i><div class="timeline-item mr-0"><span class="time"><i class="fas fa-circle"></i> 11个相关单词</span><div class="timeline-body"><div class="row"><div class="col-sm-6 col-lg-4 pt-1 mb-1 text-truncate border-bottom"><h4 class="d-inline-block" data-toggle="tooltip" data-html="true" title="" data-original-title="adj. 私人的；私有的；私下的"><a href="/word/private" class="text-lightblue" target="_blank"> private</a> <span class="text-danger">*</span></h4><small class="text-gray"><em class="phonetic">/</em>ˈpraɪvət<em class="phonetic">/</em></small><span class="btn dictvoice" data-word="private"><i class="fas fa-volume-down"></i></span><small>adj. 私人的</small></div><div class="col-sm-6 col-lg-4 pt-1 mb-1 text-truncate border-bottom"><h4 class="d-inline-block" data-toggle="tooltip" data-html="true" title="" data-original-title="n. 会话；交谈；社交"><a href="/word/conversation" class="text-lightblue" target="_blank"> conversation</a> </h4><small class="text-gray"><em class="phonetic">/</em>ˌkɒnvəˈseɪʃ(ə)n<em class="phonetic">/</em></small><span class="btn dictvoice" data-word="conversation"><i class="fas fa-volume-down"></i></span><small>n. 谈话</small></div><div class="col-sm-6 col-lg-4 pt-1 mb-1 text-truncate border-bottom"><h4 class="d-inline-block" data-toggle="tooltip" data-html="true" title="" data-original-title="n. 剧场，戏院"><a href="/word/theatre" class="text-lightblue" target="_blank"> theatre</a> </h4><small class="text-gray"><em class="phonetic">/</em>ˈθɪətə(r)<em class="phonetic">/</em></small><span class="btn dictvoice" data-word="theatre"><i class="fas fa-volume-down"></i></span><small>n. 剧场，戏院</small></div><div class="col-sm-6 col-lg-4 pt-1 mb-1 text-truncate border-bottom"><h4 class="d-inline-block" data-toggle="tooltip" data-html="true" title="" data-original-title="n. 座位；所在地；职位"><a href="/word/seat" class="text-lightblue" target="_blank"> seat</a> </h4><small class="text-gray"><em class="phonetic">/</em>siːt<em class="phonetic">/</em></small><span class="btn dictvoice" data-word="seat"><i class="fas fa-volume-down"></i></span><small>n. 座位</small></div><div class="col-sm-6 col-lg-4 pt-1 mb-1 text-truncate border-bottom"><h4 class="d-inline-block" data-toggle="tooltip" data-html="true" title="" data-original-title="adj. 生气的；愤怒的；狂暴的；（伤口等）发炎的"><a href="/word/angry" class="text-lightblue" target="_blank"> angry</a> </h4><small class="text-gray"><em class="phonetic">/</em>ˈæŋɡri<em class="phonetic">/</em></small><span class="btn dictvoice" data-word="angry"><i class="fas fa-volume-down"></i></span><small>adj. 生气的</small></div><div class="col-sm-6 col-lg-4 pt-1 mb-1 text-truncate border-bottom"><h4 class="d-inline-block" data-toggle="tooltip" data-html="true" title="" data-original-title="n. 注意力；关心；立正！（口令）"><a href="/word/attention" class="text-lightblue" target="_blank"> attention</a> </h4><small class="text-gray"><em class="phonetic">/</em>əˈtenʃ(ə)n<em class="phonetic">/</em></small><span class="btn dictvoice" data-word="attention"><i class="fas fa-volume-down"></i></span><small>n. 注意</small></div><div class="col-sm-6 col-lg-4 pt-1 mb-1 text-truncate border-bottom"><h4 class="d-inline-block" data-toggle="tooltip" data-html="true" title="" data-original-title="adv. 愤怒地"><a href="/word/angrily" class="text-lightblue" target="_blank"> angrily</a> </h4><small class="text-gray"><em class="phonetic">/</em>ˈæŋɡrəli<em class="phonetic">/</em></small><span class="btn dictvoice" data-word="angrily"><i class="fas fa-volume-down"></i></span><small>adv. 生气地</small></div><div class="col-sm-6 col-lg-4 pt-1 mb-1 text-truncate border-bottom"><h4 class="d-inline-block" data-toggle="tooltip" data-html="true" title="" data-original-title="vi. 结果实；承受"><a href="/word/bear" class="text-lightblue" target="_blank"> bear</a> <span class="text-danger">*</span></h4><small class="text-gray"><em class="phonetic">/</em>beə(r)<em class="phonetic">/</em></small><span class="btn dictvoice" data-word="bear"><i class="fas fa-volume-down"></i></span><small>v. 容忍</small></div><div class="col-sm-6 col-lg-4 pt-1 mb-1 text-truncate border-bottom"><h4 class="d-inline-block" data-toggle="tooltip" data-html="true" title="" data-original-title="n. 商业；生意；交易；事情"><a href="/word/business" class="text-lightblue" target="_blank"> business</a> </h4><small class="text-gray"><em class="phonetic">/</em>ˈbɪznəs<em class="phonetic">/</em></small><span class="btn dictvoice" data-word="business"><i class="fas fa-volume-down"></i></span><small>n. 事</small></div><div class="col-sm-6 col-lg-4 pt-1 mb-1 text-truncate"><h4 class="d-inline-block" data-toggle="tooltip" data-html="true" title="" data-original-title="adv. 无礼地；粗暴地"><a href="/word/rudely" class="text-lightblue" target="_blank"> rudely</a> </h4><small class="text-gray"><em class="phonetic">/</em>ˈruːdli<em class="phonetic">/</em></small><span class="btn dictvoice" data-word="rudely"><i class="fas fa-volume-down"></i></span><small>adv. 无礼地，粗鲁地</small></div><div class="col-sm-6 col-lg-4 pt-1 mb-1 text-truncate"><h4 class="d-inline-block" data-toggle="tooltip" data-html="true" title="" data-original-title="vt. 演奏；播放；游戏；扮演；同 … 比赛"><a href="/word/play" class="text-lightblue" target="_blank"> play</a> <span class="text-danger">*</span></h4><small class="text-gray"><em class="phonetic">/</em>pleɪ<em class="phonetic">/</em></small><span class="btn dictvoice" data-word="play"><i class="fas fa-volume-down"></i></span><small>n. 戏</small></div></div></div></div></div>

# 76 -> 001

# en/001.txt
# Lesson 1 A Private Conversation
# First listen and then answer the question:
# Why did the writer complain to the people behind him?
# Last week I went to the theatre.
# My seat was very good.
# The play was very interesting.
# I could not hear the actors.
# I turned round.
# I looked at the man and the woman angrily.
# They did not pay any attention.
# In the end, I could not bear it.
# I turned round again.
# "I can't hear a word!" I said angrily.
# "It's none of your business, " the young man said rudely. "This is a private conversation!"


# zh/001.txt
# Lesson 1 私人谈话
# Why did the writer complain to the people behind him?
# 上星期我去看戏。
# 我的座位很好。
# 戏很有意思，但我却无法欣赏。
# 一青年男子与一青年女子坐在我的身后。
# 大声地说着话。
# 我非常生气，因为我听不见演员在说什么。
# 我回过头去怒视着那一男一女。
# 他们却毫不理会。
# 最后, 我忍不住了。
# 又一次回过头去，生气地说 : "我一个字也听不见了！"
# "不关你的事，"那男的毫不客气地说，"这是私人间的谈话！"


# words/001.json
# [
#         {
#           "text": "private",
#           "translation": "私人的",
#           "phonetic": "/ˈpraɪvət/",
#           "toggle": "adj. 私人的，私立的",
#           "isDanger": 1
#         },
#         {
#           "text": "conversation",
#           "translation": "会话；交谈；社交",
#           "phonetic": "/kənˈvɜːʃən/",
#           "toggle": "n. 会话；交谈；社交",
#           "isDanger": 0
#         },
#         {
#           "text": "theatre",
#           "translation": "剧场，戏院",
#           "phonetic": "/ˈθɪətə/",
#           "toggle": "n. 剧场，戏院",
#           "isDanger": 0
#         },
# ...

# ]

# audio/001.mp3

import requests
from bs4 import BeautifulSoup
import os
import re
import time
import json
from openai import OpenAI

# Create directories if they don't exist
os.makedirs('audio', exist_ok=True)
os.makedirs('en', exist_ok=True)
os.makedirs('zh', exist_ok=True)
os.makedirs('words', exist_ok=True)

# Set your OpenAI API key
# You'll need to set this before running
client = OpenAI(
    api_key="sk-QeJTJShZ1gl5oT23MXlE8v5gYSVgfnnN2ZZ2ZLu3cF2ifkTy",
    base_url="https://api.moonshot.cn/v1",
)


def get_lesson_content(lesson_id):
    url = f"https://www.ha85.com/lessons/{lesson_id}"
    try:
        response = requests.get(url, timeout=30)
        response.raise_for_status()
        return response.text
    except requests.exceptions.RequestException as e:
        print(f"Failed to get lesson {lesson_id}: {e}")
        return None


def extract_audio_url(html_content):
    # Extract audio URL from the playAudio function
    match = re.search(r"playAudio\('(.*?)'\)", html_content)
    if match:
        return match.group(1)
    return None


def download_audio(url, lesson_num):
    # Format lesson number with leading zeros
    lesson_num_formatted = f"{lesson_num:03d}"
    file_path = f"audio/{lesson_num_formatted}.mp3"

    # Skip if file already exists
    if os.path.exists(file_path):
        print(
            f"Audio file for lesson {lesson_num_formatted} already exists, skipping download")
        return True

    try:
        response = requests.get(url, stream=True, timeout=30)
        response.raise_for_status()
        with open(file_path, 'wb') as f:
            for chunk in response.iter_content(chunk_size=1024):
                f.write(chunk)
        print(f"Downloaded audio for lesson {lesson_num_formatted}")
        return True
    except requests.exceptions.RequestException as e:
        print(
            f"Failed to download audio for lesson {lesson_num_formatted}: {e}")
        return False


def extract_vocabulary(html_content):
    soup = BeautifulSoup(html_content, 'html.parser')

    # Find the words div
    words_div = soup.find('div', id='words')
    if not words_div:
        print("Could not find vocabulary words section")
        return None

    vocabulary = []

    # Find all word entries
    word_entries = words_div.find_all('div', class_='text-truncate')

    for entry in word_entries:
        word_data = {}

        # Extract word text
        word_link = entry.find('a', class_='text-lightblue')
        if word_link:
            word_data['text'] = word_link.text.strip()

        # Check if word is marked as important (has a * marker)
        danger_span = entry.find('span', class_='text-danger')
        word_data['isDanger'] = 1 if danger_span else 0

        # Extract phonetic
        phonetic_elem = entry.find('small', class_='text-gray')
        if phonetic_elem:
            phonetic_text = phonetic_elem.text
            # Remove the phonetic markers and clean up
            phonetic = phonetic_text.replace('/', '').strip()
            word_data['phonetic'] = f"/{phonetic}/"

        # Extract translation
        translation_small = entry.find_all('small')
        if len(translation_small) > 1:  # The second small tag contains the translation
            word_data['translation'] = translation_small[-1].text.strip()

        # Extract toggle (full definition)
        title_elem = entry.find('h4', class_='d-inline-block')
        if title_elem and title_elem.has_attr('title'):
            word_data['toggle'] = title_elem['title']

        if word_data.get('text'):  # Only add if we have the word text
            vocabulary.append(word_data)

    return vocabulary


def save_vocabulary(vocabulary, filename):
    try:
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(vocabulary, f, ensure_ascii=False, indent=2)
        return True
    except Exception as e:
        print(f"Error saving vocabulary to {filename}: {e}")
        return False


def extract_text_content(html_content):
    soup = BeautifulSoup(html_content, 'html.parser')

    # Find the lesson div
    lesson_div = soup.find('div', id='lesson')
    if not lesson_div:
        print("Could not find lesson content div")
        return None, None

    # Extract the question
    question_div = soup.find('div', id='question')
    question_text = ""
    if question_div:
        # Find the span with bg-info class
        question_span = question_div.find('span', class_='bg-info')
        if question_span:
            question_text = question_span.text.strip()

    if not question_text:
        print("Warning: Could not find question text")

    english_lines = []
    chinese_lines = []

    # Add lesson title
    # Find the lesson title from the strong tag with class h5
    lesson_title_elem = soup.find('strong', class_='h5')
    if lesson_title_elem:
        # Extract the full title text, keeping all parts
        english_title = lesson_title_elem.text.strip()
        english_lines.append(english_title)
    else:
        print("Warning: Could not find lesson title")
        english_lines.append("[Missing title]")

    # Add question
    english_lines.append("First listen and then answer the question:")
    english_lines.append(question_text)

    # Translate question to Chinese using OpenAI API
    translated_question = translate_question(question_text)

    # Add lesson title in Chinese
    chinese_title_span = soup.find('span', class_='mx-2 text-gray')
    if chinese_title_span and lesson_title_elem:
        # Extract lesson number from the English title
        match = re.search(r"Lesson\s+(\d+)", lesson_title_elem.text)
        if match:
            lesson_number = match.group(1)
            chinese_title = f"Lesson {lesson_number} {chinese_title_span.text.strip()}"
            chinese_lines.append(chinese_title)
        else:
            # Fallback if number not found
            chinese_lines.append(f"Lesson {chinese_title_span.text.strip()}")
    else:
        print("Warning: Could not find Chinese lesson title")
        chinese_lines.append("[Missing title]")

    # Add instruction line in Chinese
    chinese_lines.append("先听录音，然后回答问题：")

    # Add translated question
    chinese_lines.append(translated_question)

    # Extract paragraphs
    paragraphs = lesson_div.find_all('p')
    for p in paragraphs:
        english_text = p.text.strip()
        english_lines.append(english_text)

        # Find the next Chinese div
        chinese_div = p.find_next('div', class_='chinese')
        if chinese_div:
            chinese_text = chinese_div.text.strip()
            chinese_lines.append(chinese_text)
        else:
            print(f"Warning: Missing Chinese translation for: {english_text}")
            chinese_lines.append(f"[Needs translation: {english_text}]")

    return english_lines, chinese_lines


def translate_question(question_text):
    if not question_text:
        return "[No question to translate]"

    max_retries = 3
    for attempt in range(max_retries):
        try:
            response = client.chat.completions.create(
                model="moonshot-v1-8k",
                messages=[
                    {"role": "system", "content": "You are a translator. Translate the English question to Chinese accurately."},
                    {"role": "user", "content": f"Translate this English question to Chinese: {question_text}"}
                ],
                temperature=0.3
            )
            return response.choices[0].message.content.strip()
        except Exception as e:
            print(
                f"Translation error (attempt {attempt+1}/{max_retries}): {e}")
            if attempt < max_retries - 1:
                time.sleep(2)  # Wait before retrying
            else:
                return f"[Translation needed for: {question_text}]"


def save_text_file(lines, filename):
    try:
        with open(filename, 'w', encoding='utf-8') as f:
            for line in lines:
                f.write(f"{line}\n")  # No # prefix
        return True
    except Exception as e:
        print(f"Error saving {filename}: {e}")
        return False


def save_mapping(mapping, filename="lesson_mapping.json"):
    try:
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(mapping, f, indent=2)
        print(f"Saved lesson mapping to {filename}")
        return True
    except Exception as e:
        print(f"Error saving mapping to {filename}: {e}")
        return False


def load_mapping(filename="lesson_mapping.json"):
    if not os.path.exists(filename):
        return {}

    try:
        with open(filename, 'r', encoding='utf-8') as f:
            mapping = json.load(f)
            # Convert keys from strings to integers
            return {int(k): v for k, v in mapping.items()}
    except Exception as e:
        print(f"Error loading mapping from {filename}: {e}")
        return {}


def process_lesson(lesson_id, lesson_num, mapping):
    print(f"Processing lesson {lesson_id} (#{lesson_num})")

    # Format lesson number with leading zeros
    lesson_num_formatted = f"{lesson_num:03d}"

    # Check if files already exist
    en_file = f"en/{lesson_num_formatted}.txt"
    zh_file = f"zh/{lesson_num_formatted}.txt"
    audio_file = f"audio/{lesson_num_formatted}.mp3"
    words_file = f"words/{lesson_num_formatted}.json"

    all_files_exist = all(os.path.exists(f)
                          for f in [en_file, zh_file, audio_file, words_file])

    if all_files_exist:
        print(
            f"Lesson {lesson_num_formatted} already fully processed, skipping")
        # Still update the mapping
        mapping[str(lesson_id)] = lesson_num
        return True

    html_content = get_lesson_content(lesson_id)
    if not html_content:
        return False

    success = True

    # Extract and download audio
    audio_url = extract_audio_url(html_content)
    if audio_url and not os.path.exists(audio_file):
        if not download_audio(audio_url, lesson_num):
            success = False
    elif not audio_url:
        print(f"Warning: Could not find audio URL for lesson {lesson_id}")
        success = False

    # Extract and save text content if needed
    if not os.path.exists(en_file) or not os.path.exists(zh_file):
        english_lines, chinese_lines = extract_text_content(html_content)
        if english_lines and chinese_lines:
            if not os.path.exists(en_file):
                if not save_text_file(english_lines, en_file):
                    success = False
            if not os.path.exists(zh_file):
                if not save_text_file(chinese_lines, zh_file):
                    success = False
            print(f"Saved text files for lesson {lesson_num_formatted}")
        else:
            print(
                f"Error: Could not extract text content for lesson {lesson_id}")
            success = False

    # Extract and save vocabulary if needed
    if not os.path.exists(words_file):
        vocabulary = extract_vocabulary(html_content)
        if vocabulary:
            if not save_vocabulary(vocabulary, words_file):
                success = False
            else:
                print(
                    f"Saved vocabulary file for lesson {lesson_num_formatted}")
        else:
            print(
                f"Warning: Could not extract vocabulary for lesson {lesson_id}")
            # Don't mark as failure, vocabulary might be missing for some lessons

    # Update mapping if at least partially successful
    if success:
        mapping[str(lesson_id)] = lesson_num

    return success


def main():
    # Load existing mapping
    mapping = load_mapping()

    # Starting with lesson 76 -> 001 if not in mapping
    if '76' not in mapping:
        mapping['76'] = 1  # Lesson ID 76 corresponds to Lesson 1

    # Process lessons 76 to 171
    for lesson_id in range(76, 172):
        # Calculate lesson_num
        if str(lesson_id) in mapping:
            lesson_num = mapping[str(lesson_id)]
        else:
            # For other lessons, increment from the previous known mapping
            lesson_num = lesson_id - 76 + 1

        success = process_lesson(lesson_id, lesson_num, mapping)

        # Save mapping after each lesson (in case of interruption)
        save_mapping(mapping)

        # Add a small delay to avoid overwhelming the server
        time.sleep(2)

    print("Processing complete!")


if __name__ == "__main__":
    main()
