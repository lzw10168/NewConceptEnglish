# <tr><td><a href="index.php?id=course-2-001">1-001　　Excuse me! 对不起！</a></td></tr>
# <tr><td><a href="index.php?id=course-2-003">1-003　　Sorry, sir.  对不起，先生</a></td></tr>
# <tr><td><a href="index.php?id=course-2-005">1-005　　Nice to meet you  很高兴见到你。</a></td></tr>
# <tr><td><a href="index.php?id=course-2-007">1-007　　Are you a teacher? 你是教师吗?</a></td></tr>
# <tr><td><a href="index.php?id=course-2-009">1-009　　How are you today?  今天好吗？</a></td></tr>
# <tr><td><a href="index.php?id=course-2-011">1-011　　Is this your shirt? 这是你的衬衫吗？</a></td></tr>
# <tr><td><a href="index.php?id=course-2-013">1-013　　A new dress 一件新连衣裙</a></td></tr>
# <tr><td><a href="index.php?id=course-1-015">1-015　　Your passports, please. 请出示你们的护照。</a></td></tr>
# <tr><td><a href="index.php?id=course-1-017">1-017　　How do you do 您好</a></td></tr>
# <tr><td><a href="index.php?id=course-1-019">1-019　　Tired and thirsty. </a></td></tr>
# <tr><td><a href="index.php?id=course-1-021">1-021　　Which book?</a></td></tr>
# <tr><td><a href="index.php?id=course-1-023">1-023　　Which glasses?</a></td></tr>
# <tr><td><a href="index.php?id=course-1-025">1-025　　Mrs. Smith's kitchen</a></td></tr>
# <tr><td><a href="index.php?id=course-1-027">1-027　　Mrs. Smith's living room</a></td></tr>
# <tr><td><a href="index.php?id=course-1-029">1-029　　琼斯夫人的卧室</a></td></tr>
# <tr><td><a href="index.php?id=course-1-031">1-031　　Where's Sally?</a></td></tr>
# <tr><td><a href="index.php?id=course-1-033">1-033　　A fine day</a></td></tr>
# <tr><td><a href="index.php?id=course-1-035">1-035　　Our village</a></td></tr>
# <tr><td><a href="index.php?id=course-1-037">1-037　　Making a bookcase</a></td></tr>
# <tr><td><a href="index.php?id=course-1-039">1-039　　Don't drop it!</a></td></tr>
# <tr><td><a href="index.php?id=course-1-041">1-041　　Penny's bag</a></td></tr>
# <tr><td><a href="index.php?id=course-1-043">1-043　　Hurry up!</a></td></tr>
# <tr><td><a href="index.php?id=course-1-045">1-045　　The boss's letter 老板的信</a></td></tr>
# <tr><td><a href="index.php?id=course-1-047">1-047　　A cup of coffee</a></td></tr>
# <tr><td><a href="index.php?id=course-1-049">1-049　　At the butcher's</a></td></tr>
# <tr><td><a href="index.php?id=course-1-051">1-051　　A pleasant climate</a></td></tr>
# <tr><td><a href="index.php?id=course-1-053">1-053　　An interesting climate</a></td></tr>
# <tr><td><a href="index.php?id=course-1-055">1-055　　The Sawyer family</a></td></tr>
# <tr><td><a href="index.php?id=course-1-057">1-057　　An unusual day</a></td></tr>
# <tr><td><a href="index.php?id=course-1-059">1-059　　Is that all?</a></td></tr>
# <tr><td><a href="index.php?id=course-1-061">1-061　　A  bad Cold</a></td></tr>
# <tr><td><a href="index.php?id=course-1-063">1-063　　Thank you , doctor.</a></td></tr>
# <tr><td><a href="index.php?id=course-1-065">1-065　　Not a baby.</a></td></tr>
# <tr><td><a href="index.php?id=course-1-067">1-067　　The weekend 周末</a></td></tr>
# <tr><td><a href="index.php?id=course-1-069">1-069　　the car race</a></td></tr>
# <tr><td><a href="index.php?id=course-1-071">1-071　　He's awful</a></td></tr>
# <tr><td><a href="index.php?id=course-1-073">1-073　　The way to King Street</a></td></tr>
# <tr><td><a href="index.php?id=course-1-075">1-075　　Uncomfortable shoes</a></td></tr>
# <tr><td><a href="index.php?id=course-1-077">1-077　　Terrible toothache</a></td></tr>
# <tr><td><a href="index.php?id=course-1-079">1-079　　Peggy's shopping-list</a></td></tr>
# <tr><td><a href="index.php?id=course-1-081">1-081　　Roast beef and potato</a></td></tr>
# <tr><td><a href="index.php?id=course-1-083">1-083　　Going on a holiday</a></td></tr>
# <tr><td><a href="index.php?id=course-1-085">1-085　　Paris in the Spring</a></td></tr>
# <tr><td><a href="index.php?id=course-1-087">1-087　　A car crash</a></td></tr>
# <tr><td><a href="index.php?id=course-1-089">1-089　　For Sale</a></td></tr>
# <tr><td><a href="index.php?id=course-1-091">1-091　　Poor West</a></td></tr>
# <tr><td><a href="index.php?id=course-1-093">1-093　　Our new neighbor</a></td></tr>
# <tr><td><a href="index.php?id=course-1-095">1-095　　Ticket, please.</a></td></tr>
# <tr><td><a href="index.php?id=course-1-097">1-097　　A small blue case</a></td></tr>
# <tr><td><a href="index.php?id=course-1-099">1-099　　Ow!</a></td></tr>
# <tr><td><a href="index.php?id=course-1-101">1-101　　A card from Jimmy</a></td></tr>
# <tr><td><a href="index.php?id=course-1-103">1-103　　The Intelligence test</a></td></tr>
# <tr><td><a href="index.php?id=course-1-105">1-105　　Hello, Mr.boss.</a></td></tr>
# <tr><td><a href="index.php?id=course-1-107">1-107　　It's too small</a></td></tr>
# <tr><td><a href="index.php?id=course-1-109">1-109　　A good idea</a></td></tr>
# <tr><td><a href="index.php?id=course-1-111">1-111　　The most expensive model</a></td></tr>
# <tr><td><a href="index.php?id=course-1-113">1-113　　Small Change</a></td></tr>
# <tr><td><a href="index.php?id=course-1-115">1-115　　Not...</a></td></tr>
# <tr><td><a href="index.php?id=course-1-117">1-117　　Tommy's breakfast</a></td></tr>
# <tr><td><a href="index.php?id=course-1-119">1-119　　A true story</a></td></tr>
# <tr><td><a href="index.php?id=course-1-121">1-121　　The man in the hat </a></td></tr>
# <tr><td><a href="index.php?id=course-1-123">1-123　　A trip to Australia</a></td></tr>
# <tr><td><a href="index.php?id=course-1-125">1-125　　Tea or Two</a></td></tr>
# <tr><td><a href="index.php?id=course-1-127">1-127　　A famous actress</a></td></tr>
# <tr><td><a href="index.php?id=course-1-129">1-129　　70 miles an hour</a></td></tr>
# <tr><td><a href="index.php?id=course-1-131">1-131　　Don't be so sure</a></td></tr>
# <tr><td><a href="index.php?id=course-1-133">1-133　　Sensational news</a></td></tr>
# <tr><td><a href="index.php?id=course-1-135">1-135　　The latest report</a></td></tr>
# <tr><td><a href="index.php?id=course-1-137">1-137　　A pleasant dream</a></td></tr>
# <tr><td><a href="index.php?id=course-1-139">1-139　　Is that you, John?</a></td></tr>
# <tr><td><a href="index.php?id=course-1-141">1-141　　Sally's first train ride</a></td></tr>
# <tr><td><a href="index.php?id=course-1-143">1-143　　A walk through the woods  林中散步</a></td></tr>


# <!doctype html>
# 	<html lang="zh-CN">
# 	<head>
# 		<title>新概念英语 | NewConceptEnglish.com | 新概念英语 - 第1册 - 第001课</title>
# 		<meta charset = "utf-8" />
# 		<meta name="description" content="新概念英语第一册,新概念英语第二册,新概念英语" />
# 		<meta name="keywords" content="新概念英语第一册,新概念英语第二册,新概念英语" />
# 		<meta name="author" content="新概念英语" />
# 		<meta name="viewport" content="width=device-width, initial-scale=1" />
# 		<link rel="stylesheet" href="style.css?v=1744339607">
# 		<link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
# 		<link rel="icon" href="images/favicon.ico" type="image/x-icon">
#         <script>
#           var _mtj = _mtj || [];
#           (function () {
#           var mtj = document.createElement("script");
#           mtj.src = "https://node68.aizhantj.com:21233/tjjs/?k=877yqmqeg8x";
#           var s = document.getElementsByTagName("script")[0];
#           s.parentNode.insertBefore(mtj, s);
#           })();
#         </script>
# 	</head>
# 	<body>
# 		<!--<header><a href="index.php" id="logo"><img src="images/newconceptenglish.png" width="100%" /></a></header>-->
# <!--<header><h1 id="siteheader"><a href="index.php" id="logo">新 概 念 英 语<br/><span>NewConceptEnglish.com 全网最佳英语学习系统</span></a></h1></header>-->
# <!--<header><h1 id="siteheader"><a href="index.php" id="logo">新 概 念 <span>英 语</span></a></h1></header>-->

# <h1 id="siteheader"><a href="index.php">新 概 念 英 语<br/><span id="slogan1">NewConceptEnglish.com</span></a></h1>		<nav>
# <span id="nav-left">
# <a href="index.php?id=nce-1">第一册</a>
# <a href="index.php?id=nce-2">第二册</a>
# <a href="index.php?id=nce-3">第三册</a>
# <a href="index.php?id=nce-4">第四册</a>
# </span>
# <span id="nav-right">
# nce@diqiu.org
# </span>
# </nav>		<div class= "avplayer"><p><font size=4px color=#999><a href="./index.php?id=course-1-001">⏪</a></font>&emsp;<font size=3px color=black ><span>新概念英语 - 第1册 - 第001课</span></font>&emsp;<font size=4px color=#999><a href="./index.php?id=course-1-003">⏩</a></font></p></div><div class = "avplayer"><p><audio controls><source src="./nce-mp3-en/1-001.mp3" type="audio/mp3"></source><font color=darkpink >==IE8? 不好使！无法播放本教材音视频!==</font> <br/>建议换用<a href="http://download.firefox.com.cn/releases/stub/official/zh-CN/Firefox-latest.exe">火狐浏览器</a>播放效果更好</audio></p></div><article class="article-nce">
# <div id="coursetitle">
# Excuse me! <br />对不起！</br><span>新概念英语－第1册－第001课</span>
# </div>
# <div id = "tapequestion">
# <h2>新概念英语－听录音，并回答问题</h2>
# Whose handbag is it?这是谁的手袋？
# </div>
# <div class="nce-section-title">
# <h2>新概念英语 - 小编笔记</h2>
# </div>

# <div class = "nce">
# <p><span class="tips">小编笔记：</span>这一课是新概念英语第一册的第一课，学的东西很简单（你，我，它，你的，谢谢，对不起），大家多听几遍录音，多跟着读几遍就好了。这课最有用的短语就是这个Excuse me了，太有用了，教材翻译成"对不起"，其实"对不起"也有很多含义， 这里的含义就是： "不好意思"、"劳驾了"、"毋该（粤语方言）"、"打搅了"等等。 如果你去国外出差、旅行，一定要记得使用Excuse me，这会让你显得比较文明，比较绅士，凡是你需要打扰别人，比如从别人身边挤过， 想引起一个陌生人的注意，请人帮忙，等等等等，记得先说一句 Excuse Me!</p>
# <p>另外，请注意handbag似乎特别是指女人用的手提包（或手拿包），可能有些地方叫"坤包"，有人问男的用的叫什么，我也搞不清楚，很少见到外国男同事手里拿个包的，如果是钱夹子，一般叫"wallet"，如果是上班那种正式的公文包，叫"briefcase"，如果是那种驴友用的双肩包，一般叫backpack。上飞机用拉杆箱叫suitcase等等。。大家大概了解就好了。不用特意去记哟</p>
# <p>结尾处是"thank you very much"，非常感谢的意思，下节课也会出现，还请留意。</p>
# <p>最后本课还学了词叫做"dress",特别提醒一下职场朋友，如果下次您参加某个活动(event or activity)，邀请函（invitation letter）上特别注明了dress code（着装要求），那就还是留心一下，当然，您要是马云，您穿个布鞋去也是不拘小节的"靓仔"。</p>
# </div>
# <div class="nce-section-title">
# <h2>新概念英语 - 教材原文</h2>
# </div>
# <div class = "nce">
# <h3>新概念英语－课文</h3>
# Excuse me! <br />
# Yes? <br />
# Is this your handbag? <br />
# Pardon? <br />
# Is this your handbag? <br />
# Yes, it is. <br />
# Thank you very much. 	
# </div>
# <div class = "nce">
# <h3>新概念英语－单词和短语</h3>
# excuse v. 原谅 <br />
# me pron.我(宾格) <br />
# yes adv. 是的 <br />
# is  v. be 动词现在时第三人称单数 <br />
# this pron.这 <br />
# your possessive adjective 你的，你们的 <br />
# handbag n. （女用）手提包 <br />
# pardon int. 原谅，请再说一遍<br /> 
# it pron.它 <br />
# thank you 感谢你（们）<br /> 
# very much 非常地 
# </div>
# <div class = "nce">
# <h3>新概念英语－翻译</h3>
# 对不起 <br />
# 什么事？ <br />
# 这是您的手提包吗？ <br />
# 对不起，请再说一遍。 <br />
# 这是您的手提包吗？ <br />
# 是的，是我的。 <br />
# 非常感谢！ 
# </div>
# <div class = "nce">
# <h3>Lesson 2 &nbsp; Is this your…? 这是你的…吗?</h3>
# <img alt="" src="nce-jpg/nce1-2.jpg" width="100%" style="margin:1em 0"/>
# <h3 style="clear:both;">New words and expressions生词和短语</h3>
# <p>pen  n.钢笔</p>
# <p>pencil  n.铅笔</p>
# <p>book  n.书</p>
# <p>watch  n.手表</p>
# <p>coat  n.上衣，外衣</p>
# <p>dress  n.连衣裙</p>
# <p>skirt  n.裙子</p>
# <p>shirt  n.衬衣</p>
# <p>car  n.小汽车</p>
# <p>house  n.房子</p>
# </div>
# <div class="nce-section-title">
# <h2>新概念英语 - 自学导读</h2>
# </div>
# <div class ="nce">
# <h3>课文详注 Further notes on the text</h3>
# <p><strong>1．Excuse me 对不起。</strong></p>
# <p>这是常用于表示道歉的客套话，相当于汉语中的&ldquo;劳驾&rdquo;、&ldquo;对不起&rdquo;。当我们要引起别人的注意、要打搅别人或打断别人的话时，通常都可使用这一表达方式。在课文中，男士为了吸引女士的注意而使用了这句客套话。它也可用在下列场合：向陌生人问路，借用他人的电话，从别人身边挤过，在宴席或会议中途要离开一会儿等等。</p>
# <p><strong>2．Yes？什么事？</strong></p>
# <p>课文中的 Yes？应用升调朗读，意为：&ldquo;什么事？&rdquo;Yes？以升调表示某种不肯定或询问之意，也含有请对方说下去的意思。</p>
# <p><strong>3．Pardon？对不起，请再说一遍。</strong></p>
# <p>当我们没听清或没理解对方的话并希望对方能重复一遍时，就可以使用这一表达方式。较为正式的说法是：</p>
# <p>I beg your pardon.</p>
# <p>I beg your pardon?</p>
# <p>Pardon me.</p>
# <p>它们在汉语中的意思相当于&ldquo;对不起，请再说一遍&rdquo;或者&ldquo;对不起，请再说一遍好吗？&rdquo;</p>
# <p><strong>4．Thank you very much．非常感谢！</strong></p>
# <p>这是一句表示感谢的用语，意为&ldquo;非常感谢（你）&rdquo;。请看下列类似的表达式，并注意其语气上的差异：</p>
# <p>Thank you. 谢谢（你）。</p>
# <p>Thanks! 谢谢！</p>
# <p><strong>5．数字1～10的英文写法</strong></p>
# <p>1--one&emsp; 2--two&emsp;3--three&emsp;4--four&emsp;5--five</p>
# <p>6--six&emsp;7--seven&emsp; 8--eight&emsp;9--nine&emsp;10--ten</p>
# </div>
# <div class ="nce">
# <h3>语法 Grammar in use</h3>
# <p><strong>一般疑问句</strong></p>
# <p>一般疑问句根据其结构又分为若干种。通过主谓倒装可将带有be的陈述句变为一般疑问句。即将be的适当形式移到主语之前。</p>
# <p><strong>陈述句：</strong>This is your watch<strong>. </strong>这是你的手表。</p>
# <p><strong>疑问句：</strong>Is this your watch? 这是你的手表吗？</p>
# <p>（可参见 Lessons 15～16语法部分有关 be的一般现在时形式的说明。）</p>
# </div>
# <div class ="nce">
# <h3>词汇学习&nbsp; Word study</h3>
# <p><strong>1．coat&nbsp; n. 上衣，外套：</strong></p>
# <p>Is this your coat? 这是你的外套吗？</p>
# <p>coat and skirt&lt;英&gt;（上衣、裙子匹配的）西式女套装</p>
# <p><strong>2．dress&nbsp; n.</strong></p>
# <p>（1）连衣裙；套裙：</p>
# <p>Is this your dress? 这是你的连衣裙吗？</p>
# <p>（2）服装；衣服：</p>
# <p>casual dress 便服</p>
# <p>evening dress 晚礼服</p>
# <p>dress code 着装要求（出席一些场合，要注意主办者是否再邀请函上写明dress code，以免尴尬。）</p>
# </div>
# </article>		<footer>
# <p><a href="./index.php" title="新概念英语 | New Concept English" >NewConceptEnglish.com</a> | <a href="index.php?id=about">关于新概念英语</a></p>
# <p> &copy; 2010-2025 | 敬请购买正版新概念英语教材</p>
# </footer>	</body>
# </html>

# 一般疑问句 自然拼读 Lesson 1&2 Excuse me!
# 否定句 自然拼读 Lesson 3&4 Sorry, sir.
# 冠词 国籍 Lesson 5&6 Nice to meet you.
# 人称代词 特殊疑问句 what Lesson 7&8 Are you a teacher?
# how 特殊疑问句 Lesson 9&10 How are you today?
# 特殊疑问句 whose 名词所有格 Lesson 11&12 Is this your shirt?
# 特殊疑问句 what Lesson 13&14 A new dress
# 名词变复数 拼读规则 Lesson 15&16 Your passport,please.
# 复数 who 特殊疑问句 Lesson 17&18 How do you do?
# 复数 Lesson 19&20 Tired and thirsty
# which 特殊疑问句 简单句 Lesson 21&22 Which book?
# 后置定语 介词短语 Lesson 23&24 Which glasses?
# There be 叙述文 Lesson 025&26 Mrs. Smith's kitchen
# 叙述文 Lesson 027&28 Mrs.Smith's living room
# 祈使句 Lesson 029&30 Come in, Amy.
# 时态 现在进行时 国际音标 Lesson 031&32 Where's Sally？
# 动词分类 现在进行时 Lesson 033&34 A fine day
# 所有格 Lesson 035&36 Our village
# 时态 一般将来时 Lesson 037&38 Making a bookcase
# 祈使句 双宾语 否定句 Lesson 039&40 Don't drop it!
# 量词 不可数名词 Lesson 041&42 Penny's bag
# can there here 情态动词 数词 Lesson 043&44 Hurry up!
# 情态动词 疑问句 must Lesson 045&46 The boss's letter
# 实义动词 否定句 Lesson 047&48 A cup of coffee
# 一般现在时 时态 Lesson 049&50 At the butcher's
# 时间 天气 频率副词 Lesson 051&52 A pleasant climate
# 天气 频率副词 Lesson 053&54 An interesting climate
# 动词短语 三单 Lesson 055&56 The Sawyer family
# 一般现在时 现在进行时 Lesson 057&58 An unusual day
# 序数词 have Lesson 059&60 Is that all？
# 感官动词 Lesson 061&62 A bad cold
# must 否定句 Lesson 063&64 Thank you, doctor.
# 反身代词 时间 介词 Lesson 065&66 Not a baby
# 一般过去时 Lesson 067&68 The weekend
# 一般过去时 Lesson 069&70 The car race
# 一般过去时 电话用语 Lesson 071&72 He's awful!
# 副词 组织句子 Lesson 073&74 The way to King Street
# 过去式 Lesson 075&76 Uncomfortable shoes
# 否定疑问句 Lesson 077&78 Terrible toothache
# have 英文缩写 Lesson 079&80 Carol's shopping list
# have Lesson 081&82 Roast beef and potatoes
# 现在完成时 Lesson 083&84 Going on holiday
# 现在完成时 Lesson 085&86 Paris in the spring
# 现在完成时 一般过去时 Lesson 087&88 A car crash
# 现在完成时 Lesson 089&90 For sale
# 一般将来时 will Lesson 091&92 Poor Ian!
# 时态 Lesson 093&94 Our new neighbour
# 情态动词词组 Lesson 095&96 Tickets, please
# 物主代词 Lesson 097&98 A small blue case
# 宾语从句 Lesson 099&100 Ow!
# 间接引语 反义疑问句 Lesson 101&102 A card from Jimmy
# too 反义疑问句 Lesson 103&104 The French test
# 动词不定式 Lesson 105&106 Full of mistakes
# 比较级 最高级 Lesson 107&108 It's too small
# 比较级 最高级 Lesson 109&110 A good idea
# 比较级 最高级 Lesson 111&112 The most expensive model
# 倒装句 Lesson 113&114 Small change
# 不定代词 否定前缀 Lesson 115&116 Knock, knock!
# 过去进行时 时间状语从句 同位语 一语双关 Lesson 117&118 Tommy's breakfast
# 过去完成时 Lesson 119&120 A true story
# 定语从句 Lesson 121&122 The man in a hat
# 感叹句 定语从句 Lesson 123&124 A trip to Australia
# 情态动词 Lesson 125&126 Tea for two
# 情态动词表推测 Lesson 127&128 A famous actress
# 插入语 不同时态表推测 Lesson 129&130 Seventy miles an hour
# 推测和事实的区分 Lesson 131&132 Don't be so sure!
# 转述 宾语从句 时态 Lesson 133&134 Sensational news!
# 情态动词引语 时态 过去将来时 Lesson 135&136 The latest report
# if条件状语从句 Lesson 137&138 A pleasant dream
# 宾语从句 Lesson 139&140 Is that you, John？
# 被动语态 Lesson 141&142 Sally's first train ride
# 被动语态 Lesson 143&144 A walk through the woods



import requests
from bs4 import BeautifulSoup, NavigableString
import os
import json
import re
from ha85Crawler import get_vocabulary  # 导入get_vocabulary函数

# 新概念英语 自学导读 标签列表
tag_list_map = {
    'course-1-001': {
        "tags": [
            "一般疑问句",
            "自然拼读",
        ],
        "title": "1&2 Excuse me!",
        "id": "course-1-001",
    },
}

class NCEScraper:
    def __init__(self, base_url="http://www.newconceptenglish.com"):
        self.base_url = base_url
        self.session = requests.Session()
        # Create directories if they don't exist
        os.makedirs("data", exist_ok=True)
        os.makedirs("audio/nce1", exist_ok=True)
        self.get_vocabulary = get_vocabulary  # 保存为实例方法

    def download_mp3(self, mp3_url, lesson_id):
        """Download the MP3 file for a lesson"""
        try:
            response = self.session.get(f"{self.base_url}/{mp3_url}")
            if response.status_code == 200:
                file_path = f"audio/nce1/{lesson_id}.mp3"
                with open(file_path, "wb") as f:
                    f.write(response.content)
                return file_path
        except Exception as e:
            print(f"Error downloading audio: {e}")
        return None

    def extract_text_content(self, element):
        """Extract text content preserving line breaks"""
        # Check if element is a NavigableString (direct text node)
        if isinstance(element, str) or isinstance(element, NavigableString):
            return element.strip()
            
        if not element:
            return ""
            
        content = []
        for item in element.contents:
            if isinstance(item, str):
                if item.strip():
                    content.append(item.strip())
            elif item.name == "br":
                content.append("\n")
            elif item.name in ["p", "h3", "h4"]:
                content.append(item.get_text(strip=True))
                content.append("\n")
            else:
                content.append(item.get_text(strip=True))
                
        return "".join(content).strip()

    def parse_notes_section(self, div):
        """Parse notes section with <strong> headings and paragraph children"""
        notes_structure = []
        current_note = None
        
        # Find all paragraph elements
        paragraphs = div.find_all('p')
        
        for p in paragraphs:
            # Some sections have the heading in a strong tag
            strong_tag = p.find('strong')
            
            # Check if this paragraph contains a <strong> tag (which indicates a heading)
            if strong_tag:
                # If we have a previous note with content, add it to the result
                if current_note:
                    notes_structure.append(current_note)
                
                # Create a new note with this heading
                heading_text = strong_tag.get_text(strip=True)
                
                # Remove the strong tag content from the paragraph text to avoid duplication
                p_text = p.get_text(strip=True)
                if heading_text in p_text:
                    # Get the text after the heading to see if there's additional content in same paragraph
                    remaining_text = p_text[p_text.index(heading_text) + len(heading_text):].strip()
                    
                    current_note = {
                        "heading": heading_text,
                        "children": [remaining_text] if remaining_text else []
                    }
                else:
                    current_note = {
                        "heading": heading_text,
                        "children": []
                    }
            elif current_note:
                # This is a child paragraph of the current note
                child_text = p.get_text(strip=True)
                if child_text:  # Only add non-empty paragraphs
                    current_note["children"].append(child_text)
        
        # Add the last note if there is one
        if current_note:
            notes_structure.append(current_note)
            
        return notes_structure

    def process_section_content(self, div):
        """Process a content div and extract structured data"""
        result = []
        current_heading = None
        content_buffer = []
        
        for elem in div.children:
            if elem.name in ["h3", "h4"]:
                # Save previous heading content
                if current_heading and content_buffer:
                    result.append({
                        "heading": current_heading,
                        "content": "\n".join(content_buffer)
                    })
                    content_buffer = []
                
                current_heading = elem.get_text(strip=True)
                if "新概念英语－" in current_heading:
                    current_heading = current_heading.replace("新概念英语－", "")
            elif elem.name in ["p", "div"] or (isinstance(elem, str) and elem.strip()):
                if current_heading:
                    text = self.extract_text_content(elem)
                    if text:
                        content_buffer.append(text)
                        
        # Add the last section
        if current_heading and content_buffer:
            result.append({
                "heading": current_heading,
                "content": "\n".join(content_buffer)
            })
            
        return result

    def scrape_lesson(self, lesson_id):
        """Scrape a lesson page and extract all relevant content"""
        try:
            response = self.session.get(f"{self.base_url}/index.php?id={lesson_id}")
            if response.status_code != 200:
                print(f"Failed to fetch lesson: {lesson_id}, status code: {response.status_code}")
                return None

            soup = BeautifulSoup(response.text, "html.parser")
            
            # Extract course title and subtitle
            course_title_div = soup.find("div", id="coursetitle")
            if not course_title_div:
                print(f"Could not find course title div for lesson: {lesson_id}")
                return None
                
            # Extract title parts
            title_parts = [text for text in course_title_div.stripped_strings]
            english_title = title_parts[0] if len(title_parts) > 0 else ""
            chinese_title = title_parts[1] if len(title_parts) > 1 else ""
            
            # Extract lesson info from span
            lesson_info = course_title_div.find("span").text if course_title_div.find("span") else ""
            
            # Extract audio URL
            audio_tag = soup.find("audio")
            audio_source = audio_tag.find("source")["src"] if audio_tag and audio_tag.find("source") else None
            audio_path = None
            if audio_source:
                audio_path = self.download_mp3(audio_source, lesson_id.split("-")[-1])
            
            # Extract tape question
            tape_question_div = soup.find("div", id="tapequestion")
            tape_question = {
                "question": "",
                "translation": ""
            }
            if tape_question_div and tape_question_div.get_text(strip=True):
                question_text = tape_question_div.get_text(strip=True)
                match = re.search(r'(.*?)(\s*[\u4e00-\u9fff].*)$', question_text)
                if match:
                    tape_question["question"] = match.group(1).replace("新概念英语－听录音，并回答问题", "").strip()
                    tape_question["translation"] = match.group(2).strip()
                
            # Find article content
            article = soup.find("article", class_="article-nce")
            if not article:
                print(f"Could not find article content for lesson: {lesson_id}")
                return None
                
            # Initialize structured_content - 移除vocabulary字段
            structured_content = {
                "editorNotes": "",            # 小编笔记
                "dialogueText": [],           # 课文 - the actual lesson dialogue
                "translation": [],            # 翻译
                "notesOnText": {},            # 课文详注
                "grammarNotes": {},           # 语法
                "wordStudy": {},              # 词汇学习
                "vocabulary": {}              # 词汇
            }
            
            # Keep track of divs we've already processed
            processed_divs = set()
            
            # Process the special sections first
            nce_divs = article.find_all("div", class_="nce")
            
            # Process 课文详注 (Notes on text)
            for div in nce_divs:
                section_h3 = div.find("h3")
                if section_h3 and ("详注" in section_h3.get_text() or "notes on the text" in section_h3.get_text().lower()):
                    notes = self.parse_notes_section(div)
                    structured_content["notesOnText"] = {
                        "heading": section_h3.get_text(strip=True),
                        "notes": notes
                    }
                    # Mark this div as processed
                    processed_divs.add(div)
                    break
            
            # Process 语法 (Grammar)
            for div in nce_divs:
                section_h3 = div.find("h3")
                if section_h3 and ("语法" in section_h3.get_text() or "grammar" in section_h3.get_text().lower()):
                    notes = self.parse_notes_section(div)
                    structured_content["grammarNotes"] = {
                        "heading": section_h3.get_text(strip=True),
                        "notes": notes
                    }
                    # Mark this div as processed
                    processed_divs.add(div)
                    break
            
            # Process 词汇学习 (Word study)
            for div in nce_divs:
                section_h3 = div.find("h3")
                if section_h3 and ("词汇" in section_h3.get_text() or "word study" in section_h3.get_text().lower()):
                    notes = self.parse_notes_section(div)
                    structured_content["wordStudy"] = {
                        "heading": section_h3.get_text(strip=True),
                        "notes": notes
                    }
                    # Mark this div as processed
                    processed_divs.add(div)
                    break
            
            # Process content by sections for other types of content
            content_sections = []
            current_section = None
            
            for element in article.children:
                if element.name == "div" and "nce-section-title" in element.get("class", []):
                    current_section = {
                        "sectionTitle": element.get_text(strip=True).replace("新概念英语 - ", ""),
                        "content": []
                    }
                    content_sections.append(current_section)
                elif element.name == "div" and "nce" in element.get("class", []) and current_section:
                    # Skip divs we've already processed
                    if element not in processed_divs:
                        current_section["content"].extend(self.process_section_content(element))
            
            # Process other sections
            for section in content_sections:
                for content_item in section["content"]:
                    heading = content_item["heading"].lower() if content_item["heading"] else ""
                    
                    if "笔记" in section["sectionTitle"]:
                        structured_content["editorNotes"].append(content_item)
                    elif "课文" in heading:
                        # Process lesson text into a list of dialogue lines
                        lines = content_item["content"].split('\n')
                        dialogue_lines = [line for line in lines if line.strip()]
                        structured_content["dialogueText"].append({
                            "heading": content_item["heading"],
                            "dialogue": dialogue_lines
                        })
                    elif "翻译" in heading:
                        # Process translation into a list of lines
                        lines = content_item["content"].split('\n')
                        translation_lines = [line for line in lines if line.strip()]
                        structured_content["translation"].append({
                            "heading": content_item["heading"],
                            "lines": translation_lines
                        })
                    # elif not ("详注" in heading or "语法" in heading or "词汇" in heading):
                    #     # Don't process sections we already handled
                    #     structured_content["additionalContent"].append(content_item)
            
            # 在构建lesson_data之前，获取vocabulary数据
            vocabulary_json = self.get_vocabulary(lesson_id)
            vocabulary_data = json.loads(vocabulary_json)
            vocabulary_data["heading"] = "相关词汇 Related words"
            structured_content["vocabulary"] = vocabulary_data
            # structured_content["words"] = {
            #     "heading": "相关词汇 Related words",
            #     "words": vocabulary_data
            # }
            # del structured_content["editorNotes"]
            # del structured_content["notesOnText"]
            # del structured_content["grammarNotes"]
            # del structured_content["wordStudy"]
            # Build the complete lesson data
            lesson_data = {
                "id": lesson_id,
                "lessonNumber": lesson_id.split("-")[-1],
                "title": {
                    "english": english_title,
                    "chinese": chinese_title
                },
                "lessonInfo": lesson_info,
                "audioPath": audio_path,
                "listeningQuestion": tape_question,
                "content": structured_content,
            }
            
            # Save to JSON file
            # with open(f"data/nce1/{lesson_id}.json", "w", encoding="utf-8") as f:
                # json.dump(lesson_data, f, ensure_ascii=False, indent=2)
                
            return lesson_data
            
        except Exception as e:
            print(f"Error scraping lesson {lesson_id}: {e}")
            return None

    def scrape_all_lessons(self, lesson_ids):
        """Scrape multiple lessons"""
        results = []
        for lesson_id in lesson_ids:
            print(f"Scraping lesson: {lesson_id}")
            result = self.scrape_lesson(lesson_id)
            if result:
                results.append(result)
        return results

# Example usage
if __name__ == "__main__":
    # List of lesson IDs
    lesson_ids = [
        "course-2-001",
        "course-2-002",
        "course-2-003",
        "course-2-004",
        "course-2-005",
        "course-2-006",
        "course-2-007",
        "course-2-008",
        "course-2-009",
        "course-2-010",
        "course-2-011",
        "course-2-012",
        "course-2-013",
        "course-2-014",
        "course-2-015",
        "course-2-016",
        "course-2-017",
        "course-2-018",
        "course-2-019",
        "course-2-020",
        "course-2-021",
        "course-2-022",
        "course-2-023",
        "course-2-024",
        "course-2-025",
        "course-2-026",
        "course-2-027",
        "course-2-028",
        "course-2-029",
        "course-2-030",
        "course-2-031",
        "course-2-032",
        "course-2-033",
        "course-2-034",
        "course-2-035",
        "course-2-036",
        "course-2-037",
        "course-2-038",
        "course-2-039",
        "course-2-040",
        "course-2-041", 
        "course-2-042",
        "course-2-043",
        "course-2-044",
        "course-2-045",
        "course-2-046",
        "course-2-047",
        "course-2-048",
        "course-2-049",
        "course-2-050",
        "course-2-051",
        "course-2-052",
        "course-2-053",
        "course-2-054",
        "course-2-055",
        "course-2-056",
        "course-2-057",
        "course-2-058",
        "course-2-059",
        "course-2-060",
        "course-2-061",
        "course-2-062",
        "course-2-063",
        "course-2-064",
        "course-2-065", 
        "course-2-066",
        "course-2-067",
        "course-2-068",
        "course-2-069",
        "course-2-070",
        "course-2-071",
        "course-2-072",
        "course-2-073",
        "course-2-074",
        "course-2-075",
        "course-2-076",
        "course-2-077",
        "course-2-078",
        "course-2-079",
        "course-2-080",
        "course-2-081",
        "course-2-082",
        "course-2-083",
        "course-2-084",
        "course-2-085",
        "course-2-086",
        "course-2-087",
        "course-2-088",
        "course-2-089",
        "course-2-090",
        "course-2-091", 
        "course-2-092",
        "course-2-093",
        "course-2-094",
        "course-2-095",
        "course-2-096",     
    ]
    
    scraper = NCEScraper()
    
    # Scrape a single lesson
    # lesson_data = scraper.scrape_lesson("course-2-001")
    # if lesson_data:
    #     print(f"Scraped lesson: {lesson_data['title']['english']} - {lesson_data['title']['chinese']}")
    #     print(f"Audio downloaded to: {lesson_data['audioPath']}")
    #     print(f"Data saved to: data/{lesson_data['id']}.json")
    
    # Uncomment to scrape all lessons
    results = scraper.scrape_all_lessons(lesson_ids)
    print(f"Scraped {len(results)} lessons successfully")
